<div class="page-container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-text">
        <h1>üîç Compliance Rules</h1>
        <p>Automated compliance checks and risk assessment across all cloud providers</p>
      </div>
      <div class="header-actions">
        <button class="btn btn-outline" (click)="runComplianceScan()">
          <i class="icon-refresh"></i>
          Run Scan
        </button>
        <button class="btn btn-primary" (click)="scheduleScan()">
          <i class="icon-calendar"></i>
          Schedule Scan
        </button>
      </div>
    </div>
  </div>

  <!-- Compliance Score Overview -->
  <div class="compliance-overview">
    <div class="score-card">
      <div class="score-circle" [class]="getScoreClass(overallScore)">
        <div class="score-number">{{ overallScore }}</div>
        <div class="score-label">Overall Score</div>
      </div>
      <div class="score-details">
        <h3>Compliance Status</h3>
        <p>{{ getComplianceStatus(overallScore) }}</p>
        <div class="risk-level" [class]="getRiskLevelClass(overallScore)">
          Risk Level: {{ getRiskLevel(overallScore) }}
        </div>
      </div>
    </div>
    
    <div class="framework-scores">
      <div class="framework-score" *ngFor="let framework of frameworkScores">
        <div class="framework-name">{{ framework.name }}</div>
        <div class="framework-progress">
          <div class="progress-bar">
            <div class="progress-fill" [class]="getScoreClass(framework.score)" [style.width.%]="framework.score"></div>
          </div>
          <span class="score-text">{{ framework.score }}%</span>
        </div>
        <div class="framework-status" [class]="getScoreClass(framework.score)">
          {{ getComplianceStatus(framework.score) }}
        </div>
      </div>
    </div>
  </div>

  <!-- Risk Category Breakdown -->
  <div class="risk-dashboard">
    <h2>üìä Risk Category Breakdown</h2>
    <div class="risk-categories">
      <div class="risk-category" *ngFor="let category of riskCategories">
        <div class="category-header">
          <h3>{{ category.name }}</h3>
          <div class="category-score" [class]="getScoreClass(category.score)">
            {{ category.score }}%
          </div>
        </div>
        <div class="category-details">
          <div class="risk-items">
            <div class="risk-item" *ngFor="let item of category.items" [class]="getRiskItemClass(item.status)">
              <div class="risk-icon">
                <i [class]="getRiskIcon(item.status)"></i>
              </div>
              <div class="risk-content">
                <h4>{{ item.title }}</h4>
                <p>{{ item.description }}</p>
                <div class="risk-status">{{ item.status }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Automated Compliance Checks -->
  <div class="compliance-checks">
    <div class="section-header">
      <h2>üîç Automated Compliance Checks</h2>
      <div class="scan-controls">
        <select [(ngModel)]="selectedFramework" (change)="filterByFramework()">
          <option value="">All Frameworks</option>
          <option value="GDPR">GDPR</option>
          <option value="SOC2">SOC 2</option>
          <option value="ISO27001">ISO 27001</option>
          <option value="HIPAA">HIPAA</option>
          <option value="CIS">CIS Benchmarks</option>
        </select>
        <select [(ngModel)]="selectedProvider" (change)="filterByProvider()">
          <option value="">All Providers</option>
          <option value="AWS">AWS</option>
          <option value="Azure">Azure</option>
          <option value="GCP">GCP</option>
        </select>
      </div>
    </div>

    <div class="checks-grid">
      <div class="check-card" *ngFor="let check of filteredChecks" [class]="getCheckStatusClass(check.status)">
        <div class="check-header">
          <div class="check-icon" [class]="getCheckStatusClass(check.status)">
            <i [class]="getCheckIcon(check.status)"></i>
          </div>
          <div class="check-info">
            <h3>{{ check.title }}</h3>
            <p class="check-framework">{{ check.framework }} ‚Ä¢ {{ check.provider }}</p>
            <p class="check-description">{{ check.description }}</p>
          </div>
          <div class="check-status" [class]="getCheckStatusClass(check.status)">
            {{ check.status }}
          </div>
        </div>
        
        <div class="check-details">
          <div class="check-metrics">
            <div class="metric">
              <span class="metric-label">Last Scan:</span>
              <span class="metric-value">{{ check.lastScan | date:'short' }}</span>
            </div>
            <div class="metric">
              <span class="metric-label">Next Scan:</span>
              <span class="metric-value">{{ check.nextScan | date:'short' }}</span>
            </div>
            <div class="metric">
              <span class="metric-label">Resources:</span>
              <span class="metric-value">{{ check.resourceCount }}</span>
            </div>
          </div>
          
          <div class="check-actions">
            <button class="btn btn-sm btn-outline" (click)="viewCheckDetails(check)">
              <i class="icon-eye"></i>
              Details
            </button>
            <button class="btn btn-sm btn-outline" (click)="runSingleCheck(check)">
              <i class="icon-play"></i>
              Run Now
            </button>
            <button class="btn btn-sm btn-outline" (click)="getAIRecommendation(check)">
              <i class="icon-ai"></i>
              AI Help
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Compliance Trends -->
  <div class="compliance-trends">
    <h2>üìà Compliance Trends</h2>
    <div class="trends-chart">
      <div class="chart-container">
        <div class="trend-line" *ngFor="let trend of complianceTrends">
          <div class="trend-label">{{ trend.framework }}</div>
          <div class="trend-progress">
            <div class="trend-bar">
              <div class="trend-fill" [style.width.%]="trend.currentScore"></div>
            </div>
            <span class="trend-score">{{ trend.currentScore }}%</span>
          </div>
          <div class="trend-change" [class]="trend.change > 0 ? 'positive' : 'negative'">
            <i [class]="trend.change > 0 ? 'icon-arrow-up' : 'icon-arrow-down'"></i>
            {{ Math.abs(trend.change) }}%
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- AI-Assisted Compliance Guidance -->
  <div class="ai-guidance" *ngIf="showAIGuidance">
    <div class="guidance-header">
      <h2>üí¨ AI-Assisted Compliance Guidance</h2>
      <button class="close-btn" (click)="toggleAIGuidance()">
        <i class="icon-close"></i>
      </button>
    </div>
    <div class="guidance-content">
      <div class="ai-recommendations">
        <div class="recommendation" *ngFor="let recommendation of aiRecommendations">
          <div class="recommendation-header">
            <div class="recommendation-icon">
              <i class="icon-ai"></i>
            </div>
            <div class="recommendation-title">
              <h4>{{ recommendation.title }}</h4>
              <p class="recommendation-framework">{{ recommendation.framework }} ‚Ä¢ {{ recommendation.severity }}</p>
            </div>
          </div>
          <div class="recommendation-content">
            <p class="recommendation-description">{{ recommendation.description }}</p>
            <div class="recommendation-actions">
              <button class="btn btn-sm btn-primary" (click)="implementRecommendation(recommendation)">
                <i class="icon-check"></i>
                Implement
              </button>
              <button class="btn btn-sm btn-outline" (click)="learnMore(recommendation)">
                <i class="icon-info"></i>
                Learn More
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scan Schedule Modal -->
  <div class="modal-overlay" *ngIf="showScheduleModal" (click)="closeScheduleModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Schedule Compliance Scan</h3>
        <button class="close-btn" (click)="closeScheduleModal()">
          <i class="icon-close"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Scan Frequency:</label>
          <select [(ngModel)]="scanFrequency">
            <option value="daily">Daily</option>
            <option value="weekly">Weekly</option>
            <option value="monthly">Monthly</option>
          </select>
        </div>
        <div class="form-group">
          <label>Scan Time:</label>
          <input type="time" [(ngModel)]="scanTime">
        </div>
        <div class="form-group">
          <label>Frameworks to Scan:</label>
          <div class="checkbox-group">
            <label *ngFor="let framework of availableFrameworks">
              <input type="checkbox" [value]="framework" [(ngModel)]="selectedFrameworks">
              {{ framework }}
            </label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" (click)="closeScheduleModal()">Cancel</button>
        <button class="btn btn-primary" (click)="saveSchedule()">Schedule Scan</button>
      </div>
    </div>
  </div>

  <!-- AI Chat Modal -->
  <div class="modal-overlay" *ngIf="showAIChatModal && selectedCheck" (click)="closeAIChatModal()">
    <div class="modal-content ai-chat-modal" (click)="$event.stopPropagation()">
      <div class="modal-header ai-chat-header">
        <button class="close-btn" (click)="closeAIChatModal()" title="Close" aria-label="Close">
          <span class="close-icon">√ó</span>
        </button>
        <div class="header-info">
          <div class="ai-header-title">
            <i class="icon-ai"></i>
            <h3>AI Assistant - {{ selectedCheck.title }}</h3>
          </div>
          <div class="check-context">
            <span class="context-badge">{{ selectedCheck.framework }}</span>
            <span class="context-badge">{{ selectedCheck.provider }}</span>
            <span class="context-badge" [class]="getCheckStatusClass(selectedCheck.status)">
              {{ selectedCheck.status }}
            </span>
          </div>
        </div>
      </div>
      
      <div class="ai-chat-body">
        <div class="chat-messages" #chatMessages>
          <div class="chat-message" *ngFor="let message of aiChatMessages" [class]="'message-' + message.type">
            <div class="message-avatar" [class]="'avatar-' + message.type">
              <i [class]="message.type === 'ai' ? 'icon-robot' : 'icon-user'"></i>
            </div>
            <div class="message-content-wrapper">
              <div class="message-content" [class]="'content-' + message.type">
                <div class="message-text">{{ message.content }}</div>
                <div class="message-time">{{ message.timestamp | date:'short' }}</div>
              </div>
            </div>
          </div>
          
          <!-- AI Typing Indicator -->
          <div class="chat-message message-ai" *ngIf="isAiTyping">
            <div class="message-avatar avatar-ai">
              <i class="icon-robot"></i>
            </div>
            <div class="message-content-wrapper">
              <div class="message-content content-ai">
                <div class="typing-indicator">
                  <span></span>
                  <span></span>
                  <span></span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="ai-chat-input-container">
        <div class="suggested-questions" *ngIf="aiChatMessages.length <= 1">
          <p class="suggestions-label">Try asking:</p>
          <div class="suggestion-chips">
            <button class="suggestion-chip" (click)="currentAIMessage = 'What does this check do?'; sendAIMessage()">
              What does this check do?
            </button>
            <button class="suggestion-chip" (click)="currentAIMessage = 'How do I fix the issues?'; sendAIMessage()">
              How do I fix the issues?
            </button>
            <button class="suggestion-chip" (click)="currentAIMessage = 'Why is this important?'; sendAIMessage()">
              Why is this important?
            </button>
            <button class="suggestion-chip" (click)="currentAIMessage = 'What are the requirements?'; sendAIMessage()">
              What are the requirements?
            </button>
          </div>
        </div>
        <div class="input-group">
          <input 
            type="text" 
            [(ngModel)]="currentAIMessage" 
            (keyup.enter)="sendAIMessage()"
            placeholder="Ask me anything about this compliance check..."
            class="chat-input"
            [disabled]="isAiTyping">
          <button 
            class="btn btn-primary send-btn" 
            (click)="sendAIMessage()"
            [disabled]="!currentAIMessage.trim() || isAiTyping">
            <i class="icon-send"></i>
            Send
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Compliance Check Details Modal -->
  <div class="modal-overlay" *ngIf="showDetailsModal && selectedCheck" (click)="closeDetailsModal()">
    <div class="modal-content details-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="header-info">
          <h3>{{ selectedCheck.title }}</h3>
          <div class="check-badge">
            <span class="badge" [class]="getCheckStatusClass(selectedCheck.status)">
              {{ selectedCheck.status }}
            </span>
            <span class="badge severity" [class]="'severity-' + selectedCheck.severity.toLowerCase()">
              {{ selectedCheck.severity }}
            </span>
          </div>
        </div>
        <button class="close-btn" (click)="closeDetailsModal()">
          <i class="icon-close"></i>
        </button>
      </div>
      
      <div class="modal-body details-body" *ngIf="selectedCheck.details">
        <!-- Overview Section -->
        <div class="details-section">
          <h4>üìã Overview</h4>
          <div class="overview-grid">
            <div class="overview-item">
              <span class="label">Framework:</span>
              <span class="value">{{ selectedCheck.framework }}</span>
            </div>
            <div class="overview-item">
              <span class="label">Provider:</span>
              <span class="value">{{ selectedCheck.provider }}</span>
            </div>
            <div class="overview-item">
              <span class="label">Control ID:</span>
              <span class="value">{{ selectedCheck.details.controlId }}</span>
            </div>
            <div class="overview-item">
              <span class="label">Requirement:</span>
              <span class="value">{{ selectedCheck.details.requirement }}</span>
            </div>
            <div class="overview-item">
              <span class="label">Compliance Score:</span>
              <span class="value score-value" [class]="getScoreClass(selectedCheck.details.complianceScore)">
                {{ selectedCheck.details.complianceScore }}%
              </span>
            </div>
            <div class="overview-item">
              <span class="label">Last Updated:</span>
              <span class="value">{{ selectedCheck.details.lastUpdated | date:'short' }}</span>
            </div>
          </div>
          <p class="description">{{ selectedCheck.description }}</p>
        </div>

        <!-- Resources Section -->
        <div class="details-section" *ngIf="selectedCheck.details.resources.length > 0">
          <h4>üîß Resources ({{ selectedCheck.details.resources.length }})</h4>
          <div class="resources-list">
            <div class="resource-item" *ngFor="let resource of selectedCheck.details.resources">
              <div class="resource-header">
                <div class="resource-name">
                  <strong>{{ resource.name }}</strong>
                  <span class="resource-type">{{ resource.type }}</span>
                </div>
                <span class="resource-status" [class]="resource.status.toLowerCase()">
                  {{ resource.status }}
                </span>
              </div>
              <div class="resource-meta">
                <span class="resource-region">üìç {{ resource.region }}</span>
                <span class="resource-id">ID: {{ resource.id }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Findings Section -->
        <div class="details-section" *ngIf="selectedCheck.details.findings.length > 0">
          <h4>üîç Findings ({{ selectedCheck.details.findings.length }})</h4>
          <div class="findings-list">
            <div class="finding-item" *ngFor="let finding of selectedCheck.details.findings" [class]="'severity-' + finding.severity.toLowerCase()">
              <div class="finding-header">
                <div class="finding-severity">
                  <span class="severity-badge" [class]="'severity-' + finding.severity.toLowerCase()">
                    {{ finding.severity }}
                  </span>
                  <span class="finding-status" [class]="finding.status.toLowerCase().replace('_', '-')">
                    {{ finding.status }}
                  </span>
                </div>
              </div>
              <p class="finding-description">{{ finding.description }}</p>
              <div class="finding-meta">
                <span>Resource: {{ finding.resourceId }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Remediation Steps Section -->
        <div class="details-section" *ngIf="selectedCheck.details.remediation.length > 0">
          <h4>üõ†Ô∏è Remediation Steps</h4>
          <div class="remediation-list">
            <div class="remediation-item" *ngFor="let step of selectedCheck.details.remediation">
              <div class="step-number">{{ step.step }}</div>
              <div class="step-content">
                <h5>{{ step.description }}</h5>
                <p class="step-action">{{ step.action }}</p>
                <div class="step-meta">
                  <span class="time-estimate">‚è±Ô∏è Estimated Time: {{ step.estimatedTime }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Evidence Section -->
        <div class="details-section" *ngIf="selectedCheck.details.evidence.length > 0">
          <h4>üìÑ Evidence</h4>
          <div class="evidence-list">
            <div class="evidence-item" *ngFor="let evidence of selectedCheck.details.evidence">
              <div class="evidence-header">
                <span class="evidence-type">{{ evidence.type }}</span>
                <span class="evidence-time">{{ evidence.timestamp | date:'short' }}</span>
              </div>
              <p class="evidence-description">{{ evidence.description }}</p>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-outline" (click)="closeDetailsModal()">Close</button>
        <button class="btn btn-primary" (click)="runSingleCheck(selectedCheck!)">
          <i class="icon-play"></i>
          Run Check Again
        </button>
      </div>
    </div>
  </div>
</div>
