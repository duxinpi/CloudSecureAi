<div class="page-container">
  <div class="page-header">
    <div class="header-content">
      <div class="header-text">
        <h1>Mobile Device Management (MDM)</h1>
        <p>Secure, monitor, and manage employee devices with enterprise-grade mobile device management</p>
      </div>
      <div class="header-actions">
        <button class="btn btn-primary" (click)="openEnrollmentModal()">
          <i class="icon-plus"></i>
          Enroll Device
        </button>
        <button class="btn btn-outline" (click)="syncDevices()" [disabled]="isSyncingDevices">
          <ng-container *ngIf="isSyncingDevices; else syncIcon">
            <span class="btn-spinner"></span>
          </ng-container>
          <ng-template #syncIcon>
            <i class="icon-refresh"></i>
          </ng-template>
          <span>{{ isSyncingDevices ? 'Syncing...' : 'Sync Devices' }}</span>
        </button>
        <button class="btn btn-outline" (click)="runComplianceScan()" [disabled]="isRunningComplianceScan">
          <ng-container *ngIf="isRunningComplianceScan; else complianceIcon">
            <span class="btn-spinner"></span>
          </ng-container>
          <ng-template #complianceIcon>
            <i class="icon-scan"></i>
          </ng-template>
          <span>{{ isRunningComplianceScan ? 'Running...' : 'Compliance Check' }}</span>
        </button>
      </div>
    </div>
  </div>

  <!-- MDM Statistics Overview -->
  <div class="stats-overview">
    <div class="stat-card">
      <div class="stat-icon online">
        <i class="icon-check"></i>
      </div>
      <div class="stat-content">
        <div class="stat-number">{{ enrolledDevices }}</div>
        <div class="stat-label">Enrolled</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon warning">
        <i class="icon-shield"></i>
      </div>
      <div class="stat-content">
        <div class="stat-number">{{ compliantDevices }}</div>
        <div class="stat-label">Compliant</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon critical">
        <i class="icon-alert"></i>
      </div>
      <div class="stat-content">
        <div class="stat-number">{{ nonCompliantDevices }}</div>
        <div class="stat-label">Non-Compliant</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon total">
        <i class="icon-device"></i>
      </div>
      <div class="stat-content">
        <div class="stat-number">{{ totalDevices }}</div>
        <div class="stat-label">Total Devices</div>
      </div>
    </div>
  </div>

  <!-- MDM Filters -->
  <div class="filters-section">
    <div class="filter-group">
      <label>Filter by Compliance:</label>
      <select [(ngModel)]="complianceFilter" (change)="applyFilters()">
        <option value="">All Devices</option>
        <option value="compliant">Compliant</option>
        <option value="non-compliant">Non-Compliant</option>
        <option value="at-risk">At Risk</option>
        <option value="unknown">Unknown</option>
      </select>
    </div>
    <div class="filter-group">
      <label>Filter by Device Type:</label>
      <select [(ngModel)]="typeFilter" (change)="applyFilters()">
        <option value="">All Types</option>
        <option value="smartphone">Smartphone</option>
        <option value="tablet">Tablet</option>
        <option value="laptop">Laptop</option>
        <option value="desktop">Desktop</option>
        <option value="iot">IoT Device</option>
      </select>
    </div>
    <div class="filter-group">
      <label>Filter by Platform:</label>
      <select [(ngModel)]="platformFilter" (change)="applyFilters()">
        <option value="">All Platforms</option>
        <option value="ios">iOS</option>
        <option value="android">Android</option>
        <option value="windows">Windows</option>
        <option value="macos">macOS</option>
        <option value="linux">Linux</option>
      </select>
    </div>
    <div class="filter-group">
      <label>Search:</label>
      <input type="text" [(ngModel)]="searchTerm" (input)="applyFilters()" placeholder="Search devices, users, or departments...">
    </div>
  </div>

  <!-- Devices Grid -->
  <div class="devices-grid" *ngIf="filteredDevices.length > 0; else noDevices">
    <div class="device-card" *ngFor="let device of filteredDevices" [class]="getDeviceCardClass(device)">
      <div class="card-header">
        <div class="device-info">
          <div class="device-icon" [class]="'device-' + device.deviceType.toLowerCase()">
            <i [class]="'icon-' + device.deviceType.toLowerCase()"></i>
          </div>
          <div class="device-details">
            <h3>{{ device.deviceName }}</h3>
            <p class="device-id">{{ device.deviceId }}</p>
          </div>
        </div>
        <div class="device-status">
          <span class="status" [class]="device.enrollmentStatus.toLowerCase()">{{ device.enrollmentStatus }}</span>
          <span class="compliance" [class]="device.complianceStatus.toLowerCase()">{{ device.complianceStatus }}</span>
        </div>
      </div>
      
      <div class="card-content">
        <div class="device-meta">
          <div class="meta-item">
            <i class="icon-user"></i>
            <span>{{ device.ownerName }}</span>
          </div>
          <div class="meta-item">
            <i class="icon-location"></i>
            <span>{{ device.department }}</span>
          </div>
          <div class="meta-item">
            <i class="icon-time"></i>
            <span>{{ formatLastSeen(device.lastSeen) }}</span>
          </div>
          <div class="meta-item">
            <i class="icon-shield"></i>
            <span>{{ device.platform }} {{ device.osVersion }}</span>
          </div>
          <div class="meta-item" *ngIf="device.securityAlerts > 0">
            <i class="icon-alert"></i>
            <span>{{ device.securityAlerts }} security alerts</span>
          </div>
        </div>
        
        <div class="device-specs">
          <div class="spec-item">
            <span class="spec-label">Encryption:</span>
            <span class="spec-value" [class]="device.encryptionEnabled ? 'enabled' : 'disabled'">
              {{ device.encryptionEnabled ? 'Enabled' : 'Disabled' }}
            </span>
          </div>
          <div class="spec-item">
            <span class="spec-label">Screen Lock:</span>
            <span class="spec-value" [class]="device.screenLockEnabled ? 'enabled' : 'disabled'">
              {{ device.screenLockEnabled ? 'Enabled' : 'Disabled' }}
            </span>
          </div>
          <div class="spec-item">
            <span class="spec-label">Jailbreak:</span>
            <span class="spec-value" [class]="device.isJailbroken ? 'warning' : 'safe'">
              {{ device.isJailbroken ? 'Detected' : 'Clean' }}
            </span>
          </div>
          <div class="spec-item">
            <span class="spec-label">App Store:</span>
            <span class="spec-value" [class]="device.appStoreEnabled ? 'enabled' : 'disabled'">
              {{ device.appStoreEnabled ? 'Enabled' : 'Restricted' }}
            </span>
          </div>
        </div>
        
        <div class="device-tags" *ngIf="device.tags">
          <span class="tag" *ngFor="let tag of device.tags">{{ tag }}</span>
        </div>
        
        <div class="device-alerts" *ngIf="device.recentAlerts && device.recentAlerts.length > 0">
          <div class="alert-item" *ngFor="let alert of device.recentAlerts.slice(0, 2)">
            <i class="icon-warning"></i>
            <span>{{ alert.message }}</span>
          </div>
        </div>
      </div>
      
      <div class="card-actions">
        <button class="btn btn-sm btn-outline" (click)="viewDeviceDetails(device)">
          <i class="icon-view"></i>
          Details
        </button>
        <button class="btn btn-sm btn-outline" (click)="enforcePolicy(device)">
          <i class="icon-shield"></i>
          Enforce Policy
        </button>
        <button class="btn btn-sm btn-warning" (click)="remoteWipe(device)" *ngIf="device.remoteWipeEnabled">
          <i class="icon-alert"></i>
          Remote Wipe
        </button>
        <button class="btn btn-sm btn-danger" (click)="openUnenrollModal(device, $event)">
          <i class="icon-delete"></i>
          Unenroll
        </button>
      </div>
    </div>
  </div>

  <!-- No Devices State -->
  <ng-template #noDevices>
    <div class="empty-state">
      <div class="empty-icon">
        <i class="icon-device"></i>
      </div>
      <h3>No Devices Enrolled</h3>
      <p>Start by enrolling your first device or running a compliance scan</p>
      <div class="empty-actions">
        <button class="btn btn-primary" (click)="openEnrollmentModal()">
          <i class="icon-plus"></i>
          Enroll Device
        </button>
        <button class="btn btn-outline" (click)="runComplianceScan()">
          <i class="icon-scan"></i>
          Run Compliance Scan
        </button>
      </div>
    </div>
  </ng-template>

  <!-- Device Details Modal -->
  <div class="modal-overlay" *ngIf="showDeviceModal" (click)="closeDeviceModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ isEditingDevice ? 'Edit Device' : 'Enroll New Device' }}</h3>
        <button class="close-btn" (click)="closeDeviceModal()">
          <i class="icon-close"></i>
        </button>
      </div>
      
      <form [formGroup]="deviceForm" (ngSubmit)="saveDevice()">
        <div class="modal-body">
          <div class="form-group">
            <label for="deviceName">Device Name *</label>
            <input type="text" id="deviceName" formControlName="deviceName" placeholder="Enter device name">
          </div>
          
          <div class="form-group">
            <label for="deviceType">Device Type *</label>
            <select id="deviceType" formControlName="deviceType">
              <option value="">Select device type</option>
              <option value="Smartphone">Smartphone</option>
              <option value="Tablet">Tablet</option>
              <option value="Laptop">Laptop</option>
              <option value="Desktop">Desktop</option>
              <option value="IoT">IoT Device</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="platform">Platform *</label>
            <select id="platform" formControlName="platform">
              <option value="">Select platform</option>
              <option value="iOS">iOS</option>
              <option value="Android">Android</option>
              <option value="Windows">Windows</option>
              <option value="macOS">macOS</option>
              <option value="Linux">Linux</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="operatingSystem">Operating System</label>
            <input type="text" id="operatingSystem" formControlName="operatingSystem" placeholder="e.g., iOS, Android, Windows 11">
          </div>
          
          <div class="form-group">
            <label for="osVersion">OS Version</label>
            <input type="text" id="osVersion" formControlName="osVersion" placeholder="e.g., 17.1, 14, 11">
          </div>
          
          <div class="form-group">
            <label for="ownerName">Owner Name *</label>
            <input type="text" id="ownerName" formControlName="ownerName" placeholder="e.g., John Smith">
          </div>
          
          <div class="form-group">
            <label for="department">Department *</label>
            <select id="department" formControlName="department">
              <option value="">Select department</option>
              <option value="Sales">Sales</option>
              <option value="Marketing">Marketing</option>
              <option value="Engineering">Engineering</option>
              <option value="HR">Human Resources</option>
              <option value="Finance">Finance</option>
              <option value="IT">IT</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="tags">Tags (comma-separated)</label>
            <input type="text" id="tags" formControlName="tags" placeholder="e.g., production, critical, backup">
          </div>
          
          <div class="form-group">
            <label for="description">Description</label>
            <textarea id="description" formControlName="description" rows="3" placeholder="Device description and notes"></textarea>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-outline" (click)="closeDeviceModal()">Cancel</button>
            <button type="submit" class="btn btn-primary" [disabled]="deviceForm.invalid">
              {{ isEditingDevice ? 'Update Device' : 'Enroll Device' }}
            </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Device Details View Modal -->
  <div class="modal-overlay" *ngIf="showDetailsModal" (click)="closeDetailsModal()">
    <div class="modal-content large" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Device Details - {{ selectedDevice?.deviceName }}</h3>
        <button class="close-btn" (click)="closeDetailsModal()">
          <i class="icon-close"></i>
        </button>
      </div>
      
      <div class="modal-body" *ngIf="selectedDevice">
        <div class="device-details-grid">
          <div class="detail-section">
            <h4>Basic Information</h4>
            <div class="detail-item">
              <span class="label">Device ID:</span>
              <span class="value">{{ selectedDevice.deviceId }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Type:</span>
              <span class="value">{{ selectedDevice.deviceType }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Status:</span>
              <span class="value" [class]="selectedDevice.enrollmentStatus.toLowerCase()">{{ selectedDevice.enrollmentStatus }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Compliance:</span>
              <span class="value" [class]="selectedDevice.complianceStatus.toLowerCase()">{{ selectedDevice.complianceStatus }}</span>
            </div>
          </div>
          
          <div class="detail-section">
            <h4>System Information</h4>
            <div class="detail-item">
              <span class="label">OS:</span>
              <span class="value">{{ selectedDevice.operatingSystem }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Owner:</span>
              <span class="value">{{ selectedDevice.ownerName }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Department:</span>
              <span class="value">{{ selectedDevice.department }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Last Seen:</span>
              <span class="value">{{ formatLastSeen(selectedDevice.lastSeen) }}</span>
            </div>
          </div>
          
          <div class="detail-section">
            <h4>Security Status</h4>
            <div class="security-grid">
              <div class="security-item">
                <span class="security-label">Encryption</span>
                <span class="security-value" [class]="selectedDevice.encryptionEnabled ? 'enabled' : 'disabled'">
                  {{ selectedDevice.encryptionEnabled ? 'Enabled' : 'Disabled' }}
                </span>
              </div>
              <div class="security-item">
                <span class="security-label">Screen Lock</span>
                <span class="security-value" [class]="selectedDevice.screenLockEnabled ? 'enabled' : 'disabled'">
                  {{ selectedDevice.screenLockEnabled ? 'Enabled' : 'Disabled' }}
                </span>
              </div>
              <div class="security-item">
                <span class="security-label">Jailbreak Status</span>
                <span class="security-value" [class]="selectedDevice.isJailbroken ? 'warning' : 'safe'">
                  {{ selectedDevice.isJailbroken ? 'Detected' : 'Clean' }}
                </span>
              </div>
              <div class="security-item">
                <span class="security-label">App Store</span>
                <span class="security-value" [class]="selectedDevice.appStoreEnabled ? 'enabled' : 'disabled'">
                  {{ selectedDevice.appStoreEnabled ? 'Enabled' : 'Restricted' }}
                </span>
              </div>
            </div>
          </div>
          
          <div class="detail-section" *ngIf="selectedDevice.tags && selectedDevice.tags.length > 0">
            <h4>Tags</h4>
            <div class="tags-list">
              <span class="tag" *ngFor="let tag of selectedDevice.tags">{{ tag }}</span>
            </div>
          </div>
          
          <div class="detail-section" *ngIf="selectedDevice.recentAlerts && selectedDevice.recentAlerts.length > 0">
            <h4>Recent Alerts</h4>
            <div class="alerts-list">
              <div class="alert-item" *ngFor="let alert of selectedDevice.recentAlerts">
                <div class="alert-header">
                  <span class="alert-severity" [class]="alert.severity.toLowerCase()">{{ alert.severity }}</span>
                  <span class="alert-time">{{ formatAlertTime(alert.timestamp) }}</span>
                </div>
                <div class="alert-message">{{ alert.message }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-outline" (click)="closeDetailsModal()">Close</button>
        <button class="btn btn-primary" (click)="editSelectedDevice()" *ngIf="selectedDevice">Edit Device</button>
      </div>
    </div>
  </div>

  <!-- Unenroll Confirmation Modal -->
  <div class="modal-overlay" *ngIf="showUnenrollModal" (click)="cancelUnenroll()">
    <div class="modal-content confirmation" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Unenroll Device</h3>
        <button class="close-btn" (click)="cancelUnenroll()">
          <i class="icon-close"></i>
        </button>
      </div>
      <div class="modal-body confirmation-body">
        <div class="confirmation-illustration">
          <span class="bubble bubble-primary"></span>
          <span class="bubble bubble-accent"></span>
          <div class="illustration-icon">
            <i class="icon-device"></i>
          </div>
        </div>
        <p>
          Are you sure you want to unenroll
          <strong>{{ devicePendingUnenroll?.deviceName }}</strong>? This will remove all management
          policies for the device and disable remote wipe capabilities.
        </p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" (click)="cancelUnenroll()">Cancel</button>
        <button class="btn btn-danger" (click)="confirmUnenroll()">Unenroll</button>
      </div>
    </div>
  </div>

  <!-- Action Feedback Modal -->
  <div class="modal-overlay" *ngIf="actionModal.visible" (click)="closeActionModal()">
    <div class="modal-content status" [ngClass]="actionModal.status" (click)="$event.stopPropagation()">
      <div class="modal-header action-header">
        <div class="status-illustration" [ngClass]="actionModal.status">
          <span class="status-orbit"></span>
          <span class="status-glow"></span>
          <div class="status-emblem">
            <i
              [ngClass]="{
                'icon-check': actionModal.status === 'success',
                'icon-alert': actionModal.status === 'error',
                'icon-info': actionModal.status === 'info'
              }"
            ></i>
          </div>
        </div>
        <button class="close-btn" (click)="closeActionModal()">
          <i class="icon-close"></i>
        </button>
      </div>
      <div class="modal-body status-body">
        <h3>{{ actionModal.title }}</h3>
        <p>{{ actionModal.message }}</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" (click)="closeActionModal()">Got it</button>
      </div>
    </div>
  </div>
</div>
